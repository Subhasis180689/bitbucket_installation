---
- name: Force all notified handlers to run at this point, not waiting for normal sync points
  meta: flush_handlers

- name: wait for port 7990 to be up
  wait_for:
    port: 7990
    delay: 10
    timeout: 60

- name: Copy Bitbucket dataset from s3
  get_url:
    url: "{{ atl_bitbucket_dataset_url }}"
    dest: "{{ atl_product_home_shared }}"/data/migration/import

- name: Invoke Import API
  uri: 
    url: "{{ atl_bitbucket_baseurl }}/rest/api/1.0/migration/imports"
    user: admin
    password: "{{ atl_bitbucket_admin_password }}"
    method: POST
    force_basic_auth: yes
    body: "{ \"archivePath\": \"/tmp/import/{{ atl_bitbucket_dataset_url | basename}}\" }"
    body_format: json
    return_content: yes
  register: response
  failed_when: "'INITIALISING' not in response.content"